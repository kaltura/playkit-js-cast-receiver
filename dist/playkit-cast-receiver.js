!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("kaltura-player-js")):"function"==typeof define&&define.amd?define("receiver",["kaltura-player-js"],t):"object"==typeof exports?exports.receiver=t(require("kaltura-player-js")):(e.KalturaPlayer=e.KalturaPlayer||{},e.KalturaPlayer.cast=e.KalturaPlayer.cast||{},e.KalturaPlayer.cast.receiver=t(e.KalturaPlayer))}(window,(function(e){return function(e){var t={};function a(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,a),r.l=!0,r.exports}return a.m=e,a.c=t,a.d=function(e,t,n){a.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},a.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.t=function(e,t){if(1&t&&(e=a(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(a.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)a.d(n,r,function(t){return e[t]}.bind(null,r));return n},a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,"a",t),t},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.p="",a(a.s=1)}([function(t,a){t.exports=e},function(e,t,a){"use strict";a.r(t),a.d(t,"Receiver",(function(){return _e})),a.d(t,"VERSION",(function(){return ye})),a.d(t,"NAME",(function(){return ge}));var n=a(0);function r(e){return function(e){if(Array.isArray(e))return i(e)}(e)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||function(e,t){if(!e)return;if("string"==typeof e)return i(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);"Object"===a&&e.constructor&&(a=e.constructor.name);if("Map"===a||"Set"===a)return Array.from(e);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return i(e,t)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function i(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}function s(e){return(s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function o(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function u(e,t,a){return t&&o(e.prototype,t),a&&o(e,a),e}function c(e,t){return(c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function l(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var a,n=y(e);if(t){var r=y(this).constructor;a=Reflect.construct(n,arguments,r)}else a=n.apply(this,arguments);return d(this,a)}}function d(e,t){return!t||"object"!==s(t)&&"function"!=typeof t?_(e):t}function _(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function y(e){return(y=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function g(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}n.core.Track;var f=n.core.Utils,v=n.core.FakeEvent,p=n.core.MediaType,h=n.core.getLogger,m=n.core.FakeEventTarget,E=n.core.EventManager,k=n.core.EventType,T=n.core.AudioTrack,A=n.core.TextTrack,b=n.core.AbrMode,M=n.core.MimeType,S=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&c(e,t)}(a,e);var t=l(a);function a(e,n){var r;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,a),g(_(r=t.call(this)),"_isLoaded",!1),g(_(r),"_tracks",[]),g(_(r),"_volume",1),g(_(r),"_muted",!1),g(_(r),"_paused",!1),g(_(r),"_seeking",!1),g(_(r),"_ended",!1),g(_(r),"_mediaElementEvents",[k.ABORT,k.CAN_PLAY,k.CAN_PLAY_THROUGH,k.DURATION_CHANGE,k.EMPTIED,k.ENDED,k.LOADED_DATA,k.LOADED_METADATA,k.LOAD_START,k.PAUSE,k.PLAY,k.PLAYING,k.PROGRESS,k.RATE_CHANGE,k.SEEKED,k.SEEKING,k.STALLED,k.TIME_UPDATE,k.SUSPEND,k.WAITING]),r._context=cast.framework.CastReceiverContext.getInstance(),r._playerManager=r._context.getPlayerManager(),r._eventManager=new E,r._createVideoElement(),r._init(e,n),r}return u(a,null,[{key:"canPlaySource",value:function(e){var t=e.mimetype.toLowerCase();return!!a._supportedMimeTypes.includes(t)&&(!e.drmData||M.DASH.includes(t))}},{key:"createEngine",value:function(e,t){return new this(e,t)}},{key:"id",get:function(){return"cast"}}]),u(a,[{key:"restore",value:function(e,t){this.reset(),this._init(e,t)}},{key:"attach",value:function(){var e=this,t=this.getVideoElement();this._eventManager.listen(t,k.SEEKED,(function(){return e._seeking=!1})),this._eventManager.listen(t,k.SEEKING,(function(){return e._seeking=!0})),this._eventManager.listen(t,k.ENDED,(function(){e._ended=!0,e.isLive()||e.dispatchEvent(new v(k.TIME_UPDATE))})),this.isLive()&&this._eventManager.listen(t,k.TIME_UPDATE,(function(){return e._playerManager.broadcastStatus(!0)})),this._mediaElementEvents.forEach((function(a){return e._eventManager.listen(t,a,(function(){return e.dispatchEvent(new v(a))}))}))}},{key:"detach",value:function(){}},{key:"getVideoElement",value:function(){return this._el}},{key:"load",value:function(e){return a._logger.debug("Load start",e),this._isLoaded=!0,this._parseTracks(),this.dispatchEvent(new v(k.ABR_MODE_CHANGED,{mode:b.AUTO})),a._logger.debug("Load end",this._tracks),Promise.resolve({tracks:this._tracks})}},{key:"play",value:function(){this._paused=!1}},{key:"pause",value:function(){this._paused=!0}},{key:"hideTextTrack",value:function(){}},{key:"selectTextTrack",value:function(e){this.dispatchEvent(new v(k.TEXT_TRACK_CHANGED,{selectedTextTrack:e}))}},{key:"selectAudioTrack",value:function(e){this.dispatchEvent(new v(k.AUDIO_TRACK_CHANGED,{selectedAudioTrack:e}))}},{key:"selectVideoTrack",value:function(e){this.dispatchEvent(new v(k.VIDEO_TRACK_CHANGED,{selectedVideoTrack:e}))}},{key:"enableAdaptiveBitrate",value:function(){}},{key:"isAdaptiveBitrateEnabled",value:function(){return!0}},{key:"getSelectedSource",value:function(){return f.Object.copyDeep(this._source)}},{key:"isLive",value:function(){return this._config.sources.type===p.LIVE}},{key:"seekToLiveEdge",value:function(){var e=this._playerManager.getLiveSeekableRange();e&&this._playerManager.seek(e.end)}},{key:"getStartTimeOfDvrWindow",value:function(){var e=this._playerManager.getLiveSeekableRange();return e?e.start:0}},{key:"reset",value:function(){this._eventManager.removeAll(),this._tracks=[],this._isLoaded=!1,this._paused=!1,this._seeking=!1,this._ended=!1}},{key:"destroy",value:function(){this._eventManager.destroy(),this._tracks=[],this._isLoaded=!1,this._mediaElementEvents=[],this._volume=1,this._muted=!1,this._paused=!1,this._seeking=!1,this._ended=!1,this._el&&(f.Dom.removeAttribute(this._el,"src"),f.Dom.removeChild(this._el.parentNode,this._el))}},{key:"_createVideoElement",value:function(){var e=document.getElementsByTagName(H)[0];e&&(this._el=e.getMediaElement())}},{key:"_init",value:function(e,t){this._source=e,this._config=t,this.attach()}},{key:"_parseTracks",value:function(){var e=this._playerManager.getAudioTracksManager().getTracks(),t=this._parseAudioTracks(e),a=this._playerManager.getTextTracksManager().getTracks(),n=this._parseTextTracks(a);this._tracks=t.concat(n)}},{key:"_parseTextTracks",value:function(e){var t=[];return e.forEach((function(e){var a={id:e.trackId,index:e.trackId-1,label:e.name,language:e.language,kind:e.subType||"subtitles",active:!1};t.push(new A(a))})),t}},{key:"_parseAudioTracks",value:function(e){var t=[];return e.forEach((function(e){var a={id:e.trackId,index:e.trackId-1,label:e.name,language:e.language,active:!1};t.push(new T(a))})),t}},{key:"id",get:function(){return a.id}},{key:"currentTime",set:function(e){},get:function(){return this.isLive()?this._playerManager.getCurrentTimeSec()-this.getStartTimeOfDvrWindow():this._ended?this._playerManager.getDurationSec():this._playerManager.getCurrentTimeSec()}},{key:"muted",set:function(e){this._muted=e},get:function(){return this._muted}},{key:"volume",set:function(e){this._volume=e,this.dispatchEvent(k.VOLUME_CHANGE)},get:function(){return this._volume}},{key:"paused",get:function(){return this._paused}},{key:"seeking",get:function(){return this._seeking}},{key:"buffered",get:function(){return[]}},{key:"duration",get:function(){if(this.isLive()){var e=this._playerManager.getLiveSeekableRange();if(e)return e.end-this.getStartTimeOfDvrWindow()}return this._playerManager.getDurationSec()}},{key:"src",get:function(){return this._isLoaded?this._source.url:""}},{key:"playsinline",set:function(e){},get:function(){return!0}},{key:"playbackRate",set:function(e){},get:function(){return this._playerManager.getPlaybackRate()}},{key:"playbackRates",get:function(){return[1]}},{key:"defaultPlaybackRate",get:function(){return 1}},{key:"crossOrigin",set:function(e){},get:function(){return null}},{key:"ended",get:function(){return this._ended}}],[{key:"runCapabilities",value:function(){}},{key:"prepareVideoElement",value:function(){}},{key:"getCapabilities",value:function(){return Promise.resolve(g({},a.id,{autoplay:!0,mutedAutoPlay:!0}))}}]),a}(m);g(S,"_logger",h("CastEngine")),g(S,"_supportedMimeTypes",[].concat(r(M.HLS),r(M.DASH),r(M.PROGRESSIVE),r(M.SMOOTH_STREAMING)));var C=n.core.StreamType,D=n.core.EngineType,P={playback:{autoplay:!1,preload:"none",disableUserCache:!0,streamPriority:[{engine:D.CAST,format:C.HLS},{engine:D.CAST,format:C.DASH},{engine:D.CAST,format:C.PROGRESSIVE}]},ui:{disable:!0}};var R=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.code=t.code,this.description=t.description},L={code:100020,description:"<cast-media-element> tag isn't found in the DOM"};function I(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var w=n.core.Utils,O=n.core.unRegisterEngine,B=n.core.registerEngine,x=n.core.EngineType,H="cast-media-player",U=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,a,r;return t=e,r=[{key:"loadPlayer",value:function(e){var t=w.Dom.getElementsByTagName(H)[0];if(t){var a=t.getMediaElement();a.style.position="absolute";var r=w.Dom.createElement("div");r.id="kaltura-receiver-player-container",w.Dom.appendChild(document.body,r),O(x.HTML5),B(x.CAST,S);var i=w.Object.mergeDeep({targetId:"kaltura-receiver-player-container"},P,e),s=Object(n.setup)(i);return w.Dom.prependTo(r,a.parentNode),s}throw new R(L)}}],(a=null)&&I(t.prototype,a),r&&I(t,r),e}();function N(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var j=n.cast.TextStyleConverter,K=n.core.TrackType,V=n.core.getLogger,q=function(){function e(t){var a,n,r;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),a=this,n="_logger",r=V("ReceiverTracksManager"),n in a?Object.defineProperty(a,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):a[n]=r,this._playerManager=cast.framework.CastReceiverContext.getInstance().getPlayerManager(),this._player=t,this._attachListeners()}var t,a,n;return t=e,(a=[{key:"setInitialTracks",value:function(){var e=this._playerManager.getMediaInformation();this._logger.debug("Set initial tracks",e.customData),e.customData&&(this._setInitialAudioTrack(e.customData.audioLanguage),this._setInitialTextTrack(e.customData.textLanguage))}},{key:"_attachListeners",value:function(){var e=this;this._playerManager.addEventListener(cast.framework.events.EventType.REQUEST_EDIT_TRACKS_INFO,(function(t){var a=t.requestData.activeTrackIds;if(a)e._handleAudioTrackSelection(a),e._handleTextTrackSelection(a);else{var n=t.requestData.textTrackStyle;e._handleTextStyleSelection(n)}}))}},{key:"_handleTextTrackSelection",value:function(e){var t=this._player.getTracks(K.TEXT),a=t.find((function(e){return e.active})),n=t.find((function(t){return e.includes(t.id)}));if(n)this._player.selectTrack(n);else if(a&&"off"!==a.language){var r=t.find((function(e){return"off"===e.language}));this._player.selectTrack(r)}}},{key:"_handleAudioTrackSelection",value:function(e){var t=this._player.getTracks(K.AUDIO),a=t.find((function(e){return e.active})),n=t.find((function(t){return e.includes(t.id)}));a&&n&&a.id!==n.id&&this._player.selectTrack(n)}},{key:"_handleTextStyleSelection",value:function(e){this._player.textStyle=j.toPlayerTextStyle(e)}},{key:"_setInitialTextTrack",value:function(e){var t=this._playerManager.getTextTracksManager(),a=this._player.getTracks(K.TEXT);e&&(a.some((function(t){return t.language===e}))?(this._logger.debug("Set initial text track - setActiveByLanguage",e),t.setActiveByLanguage(e)):this._logger.warn("Text track ".concat(e," doesn't exist in the supported text tracks")))}},{key:"_setInitialAudioTrack",value:function(e){var t=this._playerManager.getAudioTracksManager(),a=t.getTracks();if(this._logger.debug("Set initial audio track",e,a),a.length>0)if(e)this._logger.debug("Set initial audio track - setActiveByLanguage",e),t.setActiveByLanguage(e);else{var n=a[0].trackId,r=this._player.getTracks(K.AUDIO).find((function(e){return e.id===n}));r&&(this._logger.debug("Set initial audio track - setActiveById",n),t.setActiveById(n),this._player.selectTrack(r))}}}])&&N(t.prototype,a),n&&N(t,n),e}();function G(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function F(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}var Y=n.core.EventType,W=n.core.Ad,Q=n.core.AdBreak,X=n.core.AdBreakType,J=n.core.getLogger,$=n.core.FakeEvent,z=n.cast.CustomEventMessage,Z=function(){function e(t){var a=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),F(this,"_logger",J("ReceiverAdsManager")),F(this,"_adCanSkipTriggered",!1),F(this,"_timePercentEvent",{AD_REACHED_25_PERCENT:!1,AD_REACHED_50_PERCENT:!1,AD_REACHED_75_PERCENT:!1}),F(this,"_onPlayerLoadComplete",(function(){var e=[],t=a._playerManager.getBreakManager();if(t){var n=t.getBreaks();n&&n.length>0&&(n.forEach((function(t){return e.push(t.position)})),a._sendEventAndCustomMessage(a._player.Event.AD_MANIFEST_LOADED,{adBreaksPosition:e}))}})),F(this,"_onBreakStarted",(function(e){a._toggleAdBreakListeners(!0);var t=a._getAdBreakOptions(e),n=new Q(t);a._sendEventAndCustomMessage(a._player.Event.AD_BREAK_START,{adBreak:n}),a._adBreak=n})),F(this,"_onBreakEnded",(function(e){a._toggleAdBreakListeners(!1),a._sendEventAndCustomMessage(a._player.Event.AD_BREAK_END),a._adBreak=null;var t=a._playerManager.getBreakManager().getBreaks();t.findIndex((function(t){return t.id===e.breakId}))+1===t.length&&a._sendEventAndCustomMessage(a._player.Event.ALL_ADS_COMPLETED)})),F(this,"_onBreakClipLoading",(function(e){var t=a._getAdOptions(e),n=new W(e.breakClipId,t);a._sendEventAndCustomMessage(a._player.Event.AD_LOADED,{ad:n}),a._ad=n})),F(this,"_onBreakClipStarted",(function(e){var t=a._getAdOptions(e),n=new W(e.breakClipId,t);a._sendEventAndCustomMessage(a._player.Event.AD_STARTED,{ad:n}),a._adIsPlaying=!0})),F(this,"_onBreakClipEnded",(function(){a._sendEventAndCustomMessage(a._player.Event.AD_COMPLETED),a._adIsPlaying=!1,a._adCanSkipTriggered=!1,a._ad=null})),F(this,"_onAdPaused",(function(){a._sendEventAndCustomMessage(a._player.Event.AD_PAUSED),a._adIsPlaying=!1})),F(this,"_onAdResumed",(function(){a._sendEventAndCustomMessage(a._player.Event.AD_RESUMED),a._adIsPlaying=!0})),F(this,"_onAdProgress",(function(){if(a._ad){var e=a._playerManager.getBreakClipDurationSec(),t=a._playerManager.getBreakClipCurrentTimeSec(),n=t/e;!a._timePercentEvent.AD_REACHED_25_PERCENT&&n>=.25&&(a._timePercentEvent.AD_REACHED_25_PERCENT=!0,a._sendEventAndCustomMessage(a._player.Event.AD_FIRST_QUARTILE)),!a._timePercentEvent.AD_REACHED_50_PERCENT&&n>=.5&&(a._timePercentEvent.AD_REACHED_50_PERCENT=!0,a._sendEventAndCustomMessage(a._player.Event.AD_MIDPOINT)),!a._timePercentEvent.AD_REACHED_75_PERCENT&&n>=.75&&(a._timePercentEvent.AD_REACHED_75_PERCENT=!0,a._sendEventAndCustomMessage(a._player.Event.AD_THIRD_QUARTILE)),a._ad&&!a._adCanSkipTriggered&&a._ad&&a._ad.skippable&&t>=a._ad.skipOffset&&(a._sendEventAndCustomMessage(a._player.Event.AD_CAN_SKIP),a._adCanSkipTriggered=!0),a._sendEventAndCustomMessage(a._player.Event.AD_PROGRESS,{adProgress:{currentTime:t,duration:e}})}})),F(this,"_onMuteChange",(function(){a._player.muted&&a._sendEventAndCustomMessage(a._player.Event.AD_MUTED)})),F(this,"_onVolumeChange",(function(){a._sendEventAndCustomMessage(a._player.Event.AD_VOLUME_CHANGED)})),this._context=cast.framework.CastReceiverContext.getInstance(),this._playerManager=this._context.getPlayerManager(),this._player=t,this._attachListeners()}var t,a,n;return t=e,(a=[{key:"skipAd",value:function(){this._logger.debug("Skip ad");var e=new cast.framework.messages.RequestData(cast.framework.messages.MessageType.SKIP_AD);this._playerManager.sendLocalMediaRequest(e)}},{key:"adBreak",value:function(){return!!this._adBreak}},{key:"_attachListeners",value:function(){var e,t,a,n=this;this._adLifecycleEventHandlers=(F(e={},cast.framework.events.EventType.PLAYER_LOAD_COMPLETE,this._onPlayerLoadComplete.bind(this)),F(e,cast.framework.events.EventType.BREAK_STARTED,this._onBreakStarted.bind(this)),F(e,cast.framework.events.EventType.BREAK_ENDED,this._onBreakEnded.bind(this)),F(e,cast.framework.events.EventType.BREAK_CLIP_LOADING,this._onBreakClipLoading.bind(this)),F(e,cast.framework.events.EventType.BREAK_CLIP_STARTED,this._onBreakClipStarted.bind(this)),F(e,cast.framework.events.EventType.BREAK_CLIP_ENDED,this._onBreakClipEnded.bind(this)),e),this._adTrackingEventHandlers=(F(t={},cast.framework.events.EventType.PAUSE,this._onAdPaused.bind(this)),F(t,cast.framework.events.EventType.PLAY,this._onAdResumed.bind(this)),t),this._playerEventHandlers=(F(a={},Y.MUTE_CHANGE,this._onMuteChange.bind(this)),F(a,Y.VOLUME_CHANGE,this._onVolumeChange.bind(this)),a),Object.keys(this._adLifecycleEventHandlers).forEach((function(e){return n._playerManager.addEventListener(e,n._adLifecycleEventHandlers[e])}))}},{key:"_toggleAdBreakListeners",value:function(e){var t=this;e?(Object.keys(this._adTrackingEventHandlers).forEach((function(e){return t._playerManager.addEventListener(e,t._adTrackingEventHandlers[e])})),Object.keys(this._playerEventHandlers).forEach((function(e){return t._player.addEventListener(e,t._playerEventHandlers[e])})),this._adProgressIntervalId=setInterval(this._onAdProgress.bind(this),300)):(Object.keys(this._adTrackingEventHandlers).forEach((function(e){return t._playerManager.removeEventListener(e,t._adTrackingEventHandlers[e])})),Object.keys(this._playerEventHandlers).forEach((function(e){return t._player.removeEventListener(e,t._playerEventHandlers[e])})),this._adProgressIntervalId&&(clearInterval(this._adProgressIntervalId),this._adProgressIntervalId=null))}},{key:"_getAdBreakOptions",value:function(e){var t={},a=this._playerManager.getBreakManager().getBreakById(e.breakId);return a&&(t.position=a.position,t.type=this._getAdBreakTypeByPosition(a.position),t.numAds=a.breakClipIds.length),t}},{key:"_getAdBreakTypeByPosition",value:function(e){switch(e){case 0:return X.PRE;case-1:return X.POST;default:return X.MID}}},{key:"_getAdOptions",value:function(e){var t={},a=this._playerManager.getBreakManager().getBreakById(e.breakId);if(a){var n=this._playerManager.getBreakManager().getBreakClipById(e.breakClipId);t.url=n.contentId,t.contentType=n.contentType,t.title=n.title,t.position=a.breakClipIds.indexOf(n.id)+1,t.duration=n.duration,t.clickThroughUrl=n.clickThroughUrl,t.posterUrl=n.posterUrl,t.skipOffset=n.whenSkippable,t.linear=!0}return t}},{key:"_sendEventAndCustomMessage",value:function(e,t){this._logger.debug(e.toUpperCase(),t),this._player.dispatchEvent(new $(e,t)),this._context.sendCustomMessage(ce,void 0,new z(e,t))}}])&&G(t.prototype,a),n&&G(t,n),e}();function ee(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function te(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}n.core.FakeEvent;var ae,ne=n.core.EventManager,re=n.core.DrmScheme,ie=n.core.Utils,se=n.core.getLogger,oe=n.cast.CustomMessageType,ue=n.cast.CustomActionType,ce=(n.cast.CustomActionMessage,"urn:x-cast:com.kaltura.cast.playkit"),le=function(){function e(t){var a,n;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),te(this,"_logger",se("ReceiverManager")),te(this,"_shouldAutoPlay",!0),te(this,"_firstPlay",!0),te(this,"_messageInterceptorsHandlers",(te(a={},cast.framework.messages.MessageType.LOAD,this.onLoad),te(a,cast.framework.messages.MessageType.MEDIA_STATUS,this.onMediaStatus),te(a,cast.framework.messages.MessageType.STOP,this.onStop),a)),te(this,"_playerManagerEventHandlers",(te(n={},cast.framework.events.EventType.REQUEST_PLAY,this._onRequestPlayEvent),te(n,cast.framework.events.EventType.REQUEST_PAUSE,this._onRequestPauseEvent),te(n,cast.framework.events.EventType.PLAY,this._onPlayEvent),te(n,cast.framework.events.EventType.PLAYER_LOAD_COMPLETE,this._onPlayerLoadCompleteEvent),n)),te(this,"_castContextEventHandlers",te({},cast.framework.system.EventType.SYSTEM_VOLUME_CHANGED,this._onSystemVolumeChangedEvent)),this._context=cast.framework.CastReceiverContext.getInstance(),this._playerManager=this._context.getPlayerManager(),this._eventManager=new ne,this._player=U.loadPlayer(t),this._tracksManager=new q(this._player),this._adsManager=new Z(this._player),this._attachListeners()}var t,a,n;return t=e,(a=[{key:"getPlayer",value:function(){return this._player}},{key:"start",value:function(e){var t=new cast.framework.CastReceiverOptions;t.customNamespaces=te({},ce,cast.framework.system.MessageType.JSON),ie.Object.mergeDeep(t,e),this._logger.debug("Start receiver",t),this._context.start(t)}},{key:"onLoad",value:function(e){var t=this;return this._logger.debug("onLoad",e),this._reset(),new Promise((function(a,n){var r=e.media.customData.mediaInfo,i=e.media.customData.mediaConfig;t._maybeCreateVmapAdsRequest(e.media),t._maybeReplaceAdTagTimestamp(e.media),t._eventManager.listen(t._player,t._player.Event.ERROR,(function(e){return n(e)})),t._eventManager.listen(t._player,t._player.Event.SOURCE_SELECTED,(function(n){return t._onSourceSelected(n,e,a)})),r?(t._logger.debug("loadMedia",r),t._player.loadMedia(r)):(t._logger.debug("setMedia",i),t._player.setMedia(i))}))}},{key:"onStop",value:function(e){return this._logger.debug("onStop",e),this._destroy(),e}},{key:"onMediaStatus",value:function(e){return this._logger.debug("mediaStatus",e),e.customData=e.customData||{},this._player&&(e.customData.mediaInfo=this._player.getMediaInfo(),this._player.isLive()&&(e.currentTime=this._player.currentTime,e.media&&(e.media.duration=this._player.duration))),e.playerState!==this._playerManager.getPlayerState()&&(e.playerState=this._playerManager.getPlayerState()),e}},{key:"_attachListeners",value:function(){var e=this;this._context.addCustomMessageListener(ce,(function(t){return e._onCustomMessage(t)})),Object.keys(this._playerManagerEventHandlers).forEach((function(t){return e._playerManager.addEventListener(t,e._playerManagerEventHandlers[t].bind(e))})),Object.keys(this._messageInterceptorsHandlers).forEach((function(t){return e._playerManager.setMessageInterceptor(t,e._messageInterceptorsHandlers[t].bind(e))})),Object.keys(this._castContextEventHandlers).forEach((function(t){return e._context.addEventListener(t,e._castContextEventHandlers[t].bind(e))}))}},{key:"_reset",value:function(){this._shouldAutoPlay=!0,this._firstPlay=!0,this._eventManager.removeAll(),this._player.reset()}},{key:"_destroy",value:function(){this._shouldAutoPlay=!0,this._firstPlay=!0,this._eventManager.destroy(),this._player.destroy()}},{key:"_onSourceSelected",value:function(e,t,a){var n=this,r=e.payload.selectedSource[0];this._handleAutoPlay(t),this._handleLiveDvr(t),this._setMediaInfo(t,r),this._maybeSetDrmLicenseUrl(r);var i=this._player.config.sources;i.options&&i.options.forceRedirectExternalStreams?(this._logger.debug("Redirect stream started"),ie.Http.jsonp(t.media.contentUrl,(function(e,r){t.media.contentUrl=i.options.redirectExternalStreamsHandler(e,r),n._logger.debug("Redirect stream ended",t.media.contentUrl),a(t)}))):a(t)}},{key:"_setMediaInfo",value:function(e,t){e.media.contentId=e.media.contentId||t.id,e.media.contentUrl=e.media.contentUrl||t.url,e.media.contentType=e.media.contentType||t.mimetype,e.media.streamType=this._player.isLive()?cast.framework.messages.StreamType.LIVE:cast.framework.messages.StreamType.BUFFERED,e.media.metadata=e.media.metadata||new cast.framework.messages.GenericMediaMetadata,e.media.metadata.title=e.media.metadata.title||this._player.config.sources.metadata.name,e.media.metadata.subtitle=e.media.metadata.subtitle||this._player.config.sources.metadata.description,e.media.metadata.images=e.media.metadata.images||[{url:this._player.config.sources.poster}],e.media.hlsSegmentFormat=e.media.hlsSegmentFormat||cast.framework.messages.HlsSegmentFormat.TS,this._logger.debug("Media info has been set",e)}},{key:"_handleAutoPlay",value:function(e){e.autoplay||(this._shouldAutoPlay=!1,e.autoplay=!0)}},{key:"_handleLiveDvr",value:function(e){this._player.isDvr()?(-1===e.currentTime&&(delete e.currentTime,this._logger.debug("Live DVR will seek to live edge")),this._playerManager.removeSupportedMediaCommands(cast.framework.messages.Command.SEEK)):this._player.isLive()||this._playerManager.addSupportedMediaCommands(cast.framework.messages.Command.SEEK)}},{key:"_maybeSetDrmLicenseUrl",value:function(e){var t=this;if(e.drmData){var a=e.drmData.find((function(e){return e.scheme===re.WIDEVINE}));a&&this._playerManager.setMediaPlaybackInfoHandler((function(e,n){return n.protectionSystem=cast.framework.ContentProtection.WIDEVINE,n.licenseUrl=a.licenseUrl,t._logger.debug("Set drm license url",n),n}))}}},{key:"_onPlayEvent",value:function(){this._logger.debug("Play event",{firstPlay:this._firstPlay}),this._firstPlay&&(this._shouldAutoPlay?this._player.play():this._playerManager.pause(),this._firstPlay=!1)}},{key:"_onRequestPlayEvent",value:function(){this._logger.debug("Request play event"),this._player.play()}},{key:"_onRequestPauseEvent",value:function(){this._logger.debug("Request pause event"),this._player.pause()}},{key:"_onPlayerLoadCompleteEvent",value:function(){var e=this,t=function(){e._player.load(),e._player.ready().then((function(){return e._tracksManager.setInitialTracks()}))};this._logger.debug("Player load complete"),this._adsManager.adBreak()?this._eventManager.listenOnce(this._player,this._player.Event.AD_BREAK_END,(function(){e._eventManager.listenOnce(e._player,e._player.Event.PLAYING,t)})):t()}},{key:"_onSystemVolumeChangedEvent",value:function(e){var t=e.data;this._player.volume!==t.level&&(this._player.volume=t.level),this._player.muted!==t.muted&&(this._player.muted=t.muted)}},{key:"_onCustomMessage",value:function(e){var t=e.data;switch(this._logger.debug("Custom message received",t),t.type){case oe.ACTION:this._handleCustomAction(t)}}},{key:"_handleCustomAction",value:function(e){switch(e.action){case ue.SKIP_AD:this._adsManager.skipAd()}}},{key:"_maybeCreateVmapAdsRequest",value:function(e){e.customData&&e.customData.vmapAdsRequest&&(e.vmapAdsRequest=e.customData.vmapAdsRequest)}},{key:"_maybeReplaceAdTagTimestamp",value:function(e){var t=function(e){if(e&&a.test(e)){var t=e.match(a);return e.replace(t[1],Date.now())}return e},a=/correlator=(\[timestamp\])/;e.breakClips&&e.breakClips.forEach((function(e){e.vastAdsRequest&&e.vastAdsRequest.adTagUrl&&(e.vastAdsRequest.adTagUrl=t(e.vastAdsRequest.adTagUrl))})),e.vmapAdsRequest&&(e.vmapAdsRequest.adTagUrl=t(e.vmapAdsRequest.adTagUrl))}}])&&ee(t.prototype,a),n&&ee(t,n),e}();function de(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var _e=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),ae=new le(t)}var t,a,n;return t=e,(a=[{key:"start",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};ae.start(e)}},{key:"onLoad",value:function(e){return ae.onLoad(e)}},{key:"addEventListener",value:function(e,t){ae.getPlayer().addEventListener(e,t)}},{key:"removeEventListener",value:function(e,t){ae.getPlayer().removeEventListener(e,t)}}])&&de(t.prototype,a),n&&de(t,n),e}(),ye="0.6.0",ge="@playkit-js/playkit-js-cast-receiver"}])}));
//# sourceMappingURL=playkit-cast-receiver.js.map