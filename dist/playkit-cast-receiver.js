!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("kaltura-player-js")):"function"==typeof define&&define.amd?define("receiver",["kaltura-player-js"],t):"object"==typeof exports?exports.receiver=t(require("kaltura-player-js")):(e.KalturaPlayer=e.KalturaPlayer||{},e.KalturaPlayer.cast=e.KalturaPlayer.cast||{},e.KalturaPlayer.cast.receiver=t(e.KalturaPlayer))}("undefined"!=typeof self?self:this,function(e){return function(e){function t(n){if(a[n])return a[n].exports;var r=a[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,t),r.l=!0,r.exports}var a={};return t.m=e,t.c=a,t.d=function(e,a,n){t.o(e,a)||Object.defineProperty(e,a,{configurable:!1,enumerable:!0,get:n})},t.n=function(e){var a=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(a,"a",a),a},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=3)}([function(t,a){t.exports=e},function(e,t,a){"use strict";function n(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0}),t.ReceiverManager=t.CUSTOM_CHANNEL=void 0;var i=function(){function e(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,a,n){return a&&e(t.prototype,a),n&&e(t,n),t}}(),s=a(0),o=a(2),u=a(9),l=a(10),c=(s.core.FakeEvent,s.core.EventManager),d=s.core.DrmScheme,_=s.core.Utils,h=s.core.getLogger,y=s.cast.CustomMessageType,g=s.cast.CustomActionType,v=(s.cast.CustomActionMessage,t.CUSTOM_CHANNEL="urn:x-cast:com.kaltura.cast.playkit"),f=function(){function e(t){var a,i;r(this,e),this._logger=h("ReceiverManager"),this._shouldAutoPlay=!0,this._firstPlay=!0,this._messageInterceptorsHandlers=(a={},n(a,cast.framework.messages.MessageType.LOAD,this.onLoad),n(a,cast.framework.messages.MessageType.MEDIA_STATUS,this.onMediaStatus),n(a,cast.framework.messages.MessageType.STOP,this.onStop),a),this._playerManagerEventHandlers=(i={},n(i,cast.framework.events.EventType.REQUEST_PLAY,this._onRequestPlayEvent),n(i,cast.framework.events.EventType.REQUEST_PAUSE,this._onRequestPauseEvent),n(i,cast.framework.events.EventType.PLAY,this._onPlayEvent),n(i,cast.framework.events.EventType.PLAYER_LOAD_COMPLETE,this._onPlayerLoadCompleteEvent),i),this._castContextEventHandlers=n({},cast.framework.system.EventType.SYSTEM_VOLUME_CHANGED,this._onSystemVolumeChangedEvent),this._context=cast.framework.CastReceiverContext.getInstance(),this._playerManager=this._context.getPlayerManager(),this._eventManager=new c,this._player=o.PlayerLoader.loadPlayer(t),this._tracksManager=new u.ReceiverTracksManager(this._player),this._adsManager=new l.ReceiverAdsManager(this._player),this._attachListeners()}return i(e,[{key:"getPlayer",value:function(){return this._player}},{key:"start",value:function(e){var t=new cast.framework.CastReceiverOptions;t.customNamespaces=n({},v,cast.framework.system.MessageType.JSON),_.Object.mergeDeep(t,e),this._logger.debug("Start receiver",t),this._context.start(t)}},{key:"onLoad",value:function(e){var t=this;return this._logger.debug("onLoad",e),this._reset(),new Promise(function(a,n){var r=e.media.customData.mediaInfo;t._maybeCreateVmapAdsRequest(e.media),t._maybeReplaceAdTagTimestamp(e.media),t._eventManager.listen(t._player,t._player.Event.ERROR,function(e){return n(e)}),t._eventManager.listen(t._player,t._player.Event.SOURCE_SELECTED,function(n){return t._onSourceSelected(n,e,a)}),t._player.loadMedia(r)})}},{key:"onStop",value:function(e){return this._logger.debug("onStop",e),this._destroy(),e}},{key:"onMediaStatus",value:function(e){return this._logger.debug("mediaStatus",e),e.customData=e.customData||{},this._player&&(e.customData.mediaInfo=this._player.getMediaInfo(),this._player.isLive()&&(e.currentTime=this._player.currentTime,e.media&&(e.media.duration=this._player.duration))),e.playerState!==this._playerManager.getPlayerState()&&(e.playerState=this._playerManager.getPlayerState()),e}},{key:"_attachListeners",value:function(){var e=this;this._context.addCustomMessageListener(v,function(t){return e._onCustomMessage(t)}),Object.keys(this._playerManagerEventHandlers).forEach(function(t){return e._playerManager.addEventListener(t,e._playerManagerEventHandlers[t].bind(e))}),Object.keys(this._messageInterceptorsHandlers).forEach(function(t){return e._playerManager.setMessageInterceptor(t,e._messageInterceptorsHandlers[t].bind(e))}),Object.keys(this._castContextEventHandlers).forEach(function(t){return e._context.addEventListener(t,e._castContextEventHandlers[t].bind(e))})}},{key:"_reset",value:function(){this._shouldAutoPlay=!0,this._firstPlay=!0,this._eventManager.removeAll(),this._player.reset()}},{key:"_destroy",value:function(){this._shouldAutoPlay=!0,this._firstPlay=!0,this._eventManager.destroy(),this._player.destroy()}},{key:"_onSourceSelected",value:function(e,t,a){var n=this,r=e.payload.selectedSource[0];this._handleAutoPlay(t),this._handleLiveDvr(t),this._setMediaInfo(t,r),this._maybeSetDrmLicenseUrl(r);var i=this._player.config.sources;i.options&&i.options.forceRedirectExternalStreams?(this._logger.debug("Redirect stream started"),_.Http.jsonp(t.media.contentUrl,function(e,r){t.media.contentUrl=i.options.redirectExternalStreamsHandler(e,r),n._logger.debug("Redirect stream ended",t.media.contentUrl),a(t)})):a(t)}},{key:"_setMediaInfo",value:function(e,t){e.media.contentId=e.media.contentId||t.id,e.media.contentUrl=e.media.contentUrl||t.url,e.media.contentType=e.media.contentType||t.mimetype,e.media.streamType=this._player.isLive()?cast.framework.messages.StreamType.LIVE:cast.framework.messages.StreamType.BUFFERED,e.media.metadata=e.media.metadata||new cast.framework.messages.GenericMediaMetadata,e.media.metadata.title=e.media.metadata.title||this._player.config.sources.metadata.name,e.media.metadata.subtitle=e.media.metadata.subtitle||this._player.config.sources.metadata.description,e.media.metadata.images=e.media.metadata.images||[{url:this._player.config.sources.poster}],e.media.hlsSegmentFormat=e.media.hlsSegmentFormat||cast.framework.messages.HlsSegmentFormat.TS,this._logger.debug("Media info has been set",e)}},{key:"_handleAutoPlay",value:function(e){e.autoplay||(this._shouldAutoPlay=!1,e.autoplay=!0)}},{key:"_handleLiveDvr",value:function(e){this._player.isDvr()?(-1===e.currentTime&&(delete e.currentTime,this._logger.debug("Live DVR will seek to live edge")),this._playerManager.removeSupportedMediaCommands(cast.framework.messages.Command.SEEK)):this._player.isLive()||this._playerManager.addSupportedMediaCommands(cast.framework.messages.Command.SEEK)}},{key:"_maybeSetDrmLicenseUrl",value:function(e){var t=this;if(e.drmData){var a=e.drmData.find(function(e){return e.scheme===d.WIDEVINE});a&&this._playerManager.setMediaPlaybackInfoHandler(function(e,n){return n.protectionSystem=cast.framework.ContentProtection.WIDEVINE,n.licenseUrl=a.licenseUrl,t._logger.debug("Set drm license url",n),n})}}},{key:"_onPlayEvent",value:function(){this._logger.debug("Play event",{firstPlay:this._firstPlay}),this._firstPlay&&(this._shouldAutoPlay?this._player.play():this._playerManager.pause(),this._firstPlay=!1)}},{key:"_onRequestPlayEvent",value:function(){this._logger.debug("Request play event"),this._player.play()}},{key:"_onRequestPauseEvent",value:function(){this._logger.debug("Request pause event"),this._player.pause()}},{key:"_onPlayerLoadCompleteEvent",value:function(){var e=this,t=function(){e._player.load(),e._player.ready().then(function(){return e._tracksManager.setInitialTracks()})};this._logger.debug("Player load complete"),this._adsManager.adBreak()?this._eventManager.listenOnce(this._player,this._player.Event.AD_BREAK_END,function(){e._eventManager.listenOnce(e._player,e._player.Event.PLAYING,t)}):t()}},{key:"_onSystemVolumeChangedEvent",value:function(e){var t=e.data;this._player.volume!==t.level&&(this._player.volume=t.level),this._player.muted!==t.muted&&(this._player.muted=t.muted)}},{key:"_onCustomMessage",value:function(e){var t=e.data;switch(this._logger.debug("Custom message received",t),t.type){case y.ACTION:this._handleCustomAction(t)}}},{key:"_handleCustomAction",value:function(e){switch(e.action){case g.SKIP_AD:this._adsManager.skipAd()}}},{key:"_maybeCreateVmapAdsRequest",value:function(e){e.customData&&e.customData.vmapAdsRequest&&(e.vmapAdsRequest=e.customData.vmapAdsRequest)}},{key:"_maybeReplaceAdTagTimestamp",value:function(e){var t=function(e){if(e&&a.test(e)){var t=e.match(a);return e.replace(t[1],Date.now())}return e},a=/correlator=(\[timestamp\])/;if(e.breakClips){e.breakClips.forEach(function(e){e.vastAdsRequest&&e.vastAdsRequest.adTagUrl&&(e.vastAdsRequest.adTagUrl=t(e.vastAdsRequest.adTagUrl))})}e.vmapAdsRequest&&(e.vmapAdsRequest.adTagUrl=t(e.vmapAdsRequest.adTagUrl))}}]),e}();t.ReceiverManager=f},function(e,t,a){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0}),t.PlayerLoader=t.CAST_MEDIA_PLAYER_TAG=void 0;var r=function(){function e(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,a,n){return a&&e(t.prototype,a),n&&e(t,n),t}}(),i=a(0),s=a(5),o=a(6),u=a(7),l=a(8),c=i.core.Utils,d=i.core.unRegisterEngine,_=i.core.registerEngine,h=i.core.EngineType,y=t.CAST_MEDIA_PLAYER_TAG="cast-media-player",g=function(){function e(){n(this,e)}return r(e,null,[{key:"loadPlayer",value:function(e){var t=c.Dom.getElementsByTagName(y)[0];if(t){var a=t.getMediaElement();a.style.position="absolute";var n=c.Dom.createElement("div");n.id="kaltura-receiver-player-container",c.Dom.appendChild(document.body,n),d(h.HTML5),_(h.CAST,s.CastEngine);var r=c.Object.mergeDeep({targetId:"kaltura-receiver-player-container"},o.DefaultPlayerConfig,e),g=(0,i.setup)(r);return c.Dom.prependTo(n,a.parentNode),g}throw new u.ReceiverError(l.ErrorType.CAST_ELEMENT_NOT_FOUND)}}]),e}();t.PlayerLoader=g},function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NAME=t.VERSION=t.Receiver=void 0;var n=a(4);t.Receiver=n.ReceiverManagerAPI,t.VERSION="0.3.0",t.NAME="@playkit-js/playkit-js-cast-receiver"},function(e,t,a){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0}),t.ReceiverManagerAPI=void 0;var r=function(){function e(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,a,n){return a&&e(t.prototype,a),n&&e(t,n),t}}(),i=a(1),s=void 0,o=function(){function e(t){n(this,e),s=new i.ReceiverManager(t)}return r(e,[{key:"start",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};s.start(e)}},{key:"onLoad",value:function(e){return s.onLoad(e)}},{key:"addEventListener",value:function(e,t){s.getPlayer().addEventListener(e,t)}},{key:"removeEventListener",value:function(e,t){s.getPlayer().removeEventListener(e,t)}}]),e}();t.ReceiverManagerAPI=o},function(e,t,a){"use strict";function n(e){if(Array.isArray(e)){for(var t=0,a=Array(e.length);t<e.length;t++)a[t]=e[t];return a}return Array.from(e)}function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.CastEngine=void 0;var u=function(){function e(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,a,n){return a&&e(t.prototype,a),n&&e(t,n),t}}(),l=a(0),c=a(2),d=(l.core.Track,l.core.Utils),_=l.core.FakeEvent,h=l.core.MediaType,y=l.core.getLogger,g=l.core.FakeEventTarget,v=l.core.EventManager,f=l.core.EventType,p=l.core.AudioTrack,E=l.core.TextTrack,m=l.core.AbrMode,k=l.core.MimeType,A=function(e){function t(e,a){i(this,t);var n=s(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n._isLoaded=!1,n._tracks=[],n._volume=1,n._muted=!1,n._paused=!1,n._seeking=!1,n._ended=!1,n._mediaElementEvents=[f.ABORT,f.CAN_PLAY,f.CAN_PLAY_THROUGH,f.DURATION_CHANGE,f.EMPTIED,f.ENDED,f.LOADED_DATA,f.LOADED_METADATA,f.LOAD_START,f.PAUSE,f.PLAY,f.PLAYING,f.PROGRESS,f.RATE_CHANGE,f.SEEKED,f.SEEKING,f.STALLED,f.TIME_UPDATE,f.SUSPEND,f.WAITING],n._context=cast.framework.CastReceiverContext.getInstance(),n._playerManager=n._context.getPlayerManager(),n._eventManager=new v,n._createVideoElement(),n._init(e,a),n}return o(t,e),u(t,null,[{key:"canPlaySource",value:function(e){var a=e.mimetype.toLowerCase();return!!t._supportedMimeTypes.includes(a)&&(!e.drmData||k.DASH.includes(a))}},{key:"createEngine",value:function(e,t){return new this(e,t)}},{key:"id",get:function(){return"cast"}}]),u(t,[{key:"restore",value:function(e,t){this.reset(),this._init(e,t)}},{key:"attach",value:function(){var e=this,t=this.getVideoElement();this._eventManager.listen(t,f.SEEKED,function(){return e._seeking=!1}),this._eventManager.listen(t,f.SEEKING,function(){return e._seeking=!0}),this._eventManager.listen(t,f.ENDED,function(){e._ended=!0,e.isLive()||e.dispatchEvent(new _(f.TIME_UPDATE))}),this.isLive()&&this._eventManager.listen(t,f.TIME_UPDATE,function(){return e._playerManager.broadcastStatus(!0)}),this._mediaElementEvents.forEach(function(a){return e._eventManager.listen(t,a,function(){return e.dispatchEvent(new _(a))})})}},{key:"detach",value:function(){}},{key:"getVideoElement",value:function(){return this._el}},{key:"load",value:function(e){return t._logger.debug("Load start",e),this._isLoaded=!0,this._parseTracks(),this.dispatchEvent(new _(f.ABR_MODE_CHANGED,{mode:m.AUTO})),t._logger.debug("Load end",this._tracks),Promise.resolve({tracks:this._tracks})}},{key:"play",value:function(){this._paused=!1}},{key:"pause",value:function(){this._paused=!0}},{key:"hideTextTrack",value:function(){}},{key:"selectTextTrack",value:function(e){this.dispatchEvent(new _(f.TEXT_TRACK_CHANGED,{selectedTextTrack:e}))}},{key:"selectAudioTrack",value:function(e){this.dispatchEvent(new _(f.AUDIO_TRACK_CHANGED,{selectedAudioTrack:e}))}},{key:"selectVideoTrack",value:function(e){this.dispatchEvent(new _(f.VIDEO_TRACK_CHANGED,{selectedVideoTrack:e}))}},{key:"enableAdaptiveBitrate",value:function(){}},{key:"isAdaptiveBitrateEnabled",value:function(){return!0}},{key:"getSelectedSource",value:function(){return d.Object.copyDeep(this._source)}},{key:"isLive",value:function(){return this._config.sources.type===h.LIVE}},{key:"seekToLiveEdge",value:function(){var e=this._playerManager.getLiveSeekableRange();e&&this._playerManager.seek(e.end)}},{key:"getStartTimeOfDvrWindow",value:function(){var e=this._playerManager.getLiveSeekableRange();return e?e.start:0}},{key:"reset",value:function(){this._eventManager.removeAll(),this._tracks=[],this._isLoaded=!1,this._paused=!1,this._seeking=!1,this._ended=!1}},{key:"destroy",value:function(){this._eventManager.destroy(),this._tracks=[],this._isLoaded=!1,this._mediaElementEvents=[],this._volume=1,this._muted=!1,this._paused=!1,this._seeking=!1,this._ended=!1,this._el&&(d.Dom.removeAttribute(this._el,"src"),d.Dom.removeChild(this._el.parentNode,this._el))}},{key:"_createVideoElement",value:function(){var e=document.getElementsByTagName(c.CAST_MEDIA_PLAYER_TAG)[0];e&&(this._el=e.getMediaElement())}},{key:"_init",value:function(e,t){this._source=e,this._config=t,this.attach()}},{key:"_parseTracks",value:function(){var e=this._playerManager.getAudioTracksManager(),t=e.getTracks(),a=this._parseAudioTracks(t),n=this._playerManager.getTextTracksManager(),r=n.getTracks(),i=this._parseTextTracks(r);this._tracks=a.concat(i)}},{key:"_parseTextTracks",value:function(e){var t=[];return e.forEach(function(e){var a={id:e.trackId,index:e.trackId-1,label:e.name,language:e.language,kind:e.subType||"subtitles",active:!1};t.push(new E(a))}),t}},{key:"_parseAudioTracks",value:function(e){var t=[];return e.forEach(function(e){var a={id:e.trackId,index:e.trackId-1,label:e.name,language:e.language,active:!1};t.push(new p(a))}),t}},{key:"id",get:function(){return t.id}},{key:"currentTime",set:function(e){},get:function(){return this.isLive()?this._playerManager.getCurrentTimeSec()-this.getStartTimeOfDvrWindow():this._ended?this._playerManager.getDurationSec():this._playerManager.getCurrentTimeSec()}},{key:"muted",set:function(e){this._muted=e},get:function(){return this._muted}},{key:"volume",set:function(e){this._volume=e,this.dispatchEvent(f.VOLUME_CHANGE)},get:function(){return this._volume}},{key:"paused",get:function(){return this._paused}},{key:"seeking",get:function(){return this._seeking}},{key:"buffered",get:function(){return[]}},{key:"duration",get:function(){if(this.isLive()){var e=this._playerManager.getLiveSeekableRange();if(e)return e.end-this.getStartTimeOfDvrWindow()}return this._playerManager.getDurationSec()}},{key:"src",get:function(){return this._isLoaded?this._source.url:""}},{key:"playsinline",set:function(e){},get:function(){return!0}},{key:"playbackRate",set:function(e){},get:function(){return this._playerManager.getPlaybackRate()}},{key:"playbackRates",get:function(){return[1]}},{key:"defaultPlaybackRate",get:function(){return 1}},{key:"crossOrigin",set:function(e){},get:function(){}},{key:"ended",get:function(){return this._ended}}],[{key:"runCapabilities",value:function(){}},{key:"prepareVideoElement",value:function(){}},{key:"getCapabilities",value:function(){return Promise.resolve(r({},t.id,{autoplay:!0,mutedAutoPlay:!0}))}}]),t}(g);A._logger=y("CastEngine"),A._supportedMimeTypes=[].concat(n(k.HLS),n(k.DASH),n(k.PROGRESSIVE),n(k.SMOOTH_STREAMING)),t.CastEngine=A},function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultPlayerConfig=void 0;var n=a(0),r=n.core.StreamType,i=n.core.EngineType,s={playback:{autoplay:!1,preload:"none",disableUserCache:!0,streamPriority:[{engine:i.CAST,format:r.HLS},{engine:i.CAST,format:r.DASH},{engine:i.CAST,format:r.PROGRESSIVE}]},ui:{disable:!0}};t.DefaultPlayerConfig=s},function(e,t,a){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var r=function e(t){n(this,e),this.code=t.code,this.description=t.description};t.ReceiverError=r},function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n={CAST_ELEMENT_NOT_FOUND:{code:100020,description:"<cast-media-element> tag isn't found in the DOM"}};t.ErrorType=n},function(e,t,a){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0}),t.ReceiverTracksManager=void 0;var r=function(){function e(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,a,n){return a&&e(t.prototype,a),n&&e(t,n),t}}(),i=a(0),s=i.cast.TextStyleConverter,o=i.core.TrackType,u=i.core.getLogger,l=function(){function e(t){n(this,e),this._logger=u("ReceiverTracksManager"),this._playerManager=cast.framework.CastReceiverContext.getInstance().getPlayerManager(),this._player=t,this._attachListeners()}return r(e,[{key:"setInitialTracks",value:function(){var e=this._playerManager.getMediaInformation();this._logger.debug("Set initial tracks",e.customData),e.customData&&(this._setInitialAudioTrack(e.customData.audioLanguage),this._setInitialTextTrack(e.customData.textLanguage))}},{key:"_attachListeners",value:function(){var e=this;this._playerManager.addEventListener(cast.framework.events.EventType.REQUEST_EDIT_TRACKS_INFO,function(t){var a=t.requestData.activeTrackIds;if(a)e._handleAudioTrackSelection(a),e._handleTextTrackSelection(a);else{var n=t.requestData.textTrackStyle;e._handleTextStyleSelection(n)}})}},{key:"_handleTextTrackSelection",value:function(e){var t=this._player.getTracks(o.TEXT),a=t.find(function(e){return e.active}),n=t.find(function(t){return e.includes(t.id)});if(n)this._player.selectTrack(n);else if(a&&"off"!==a.language){var r=t.find(function(e){return"off"===e.language});this._player.selectTrack(r)}}},{key:"_handleAudioTrackSelection",value:function(e){var t=this._player.getTracks(o.AUDIO),a=t.find(function(e){return e.active}),n=t.find(function(t){return e.includes(t.id)});a&&n&&a.id!==n.id&&this._player.selectTrack(n)}},{key:"_handleTextStyleSelection",value:function(e){this._player.textStyle=s.toPlayerTextStyle(e)}},{key:"_setInitialTextTrack",value:function(e){var t=this._playerManager.getTextTracksManager();e&&(this._logger.debug("Set initial text track - setActiveByLanguage",e),t.setActiveByLanguage(e))}},{key:"_setInitialAudioTrack",value:function(e){var t=this._playerManager.getAudioTracksManager(),a=t.getTracks();if(this._logger.debug("Set initial audio track",e,a),a.length>0)if(e)this._logger.debug("Set initial audio track - setActiveByLanguage",e),t.setActiveByLanguage(e);else{var n=a[0].trackId,r=this._player.getTracks(o.AUDIO).find(function(e){return e.id===n});r&&(this._logger.debug("Set initial audio track - setActiveById",n),t.setActiveById(n),this._player.selectTrack(r))}}}]),e}();t.ReceiverTracksManager=l},function(e,t,a){"use strict";function n(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0}),t.ReceiverAdsManager=void 0;var i=function(){function e(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,a,n){return a&&e(t.prototype,a),n&&e(t,n),t}}(),s=a(0),o=a(1),u=s.core.EventType,l=s.core.Ad,c=s.core.AdBreak,d=s.core.AdBreakType,_=s.core.getLogger,h=s.core.FakeEvent,y=s.cast.CustomEventMessage,g=function(){function e(t){r(this,e),this._logger=_("ReceiverAdsManager"),this._timePercentEvent={AD_REACHED_25_PERCENT:!1,AD_REACHED_50_PERCENT:!1,AD_REACHED_75_PERCENT:!1},this._context=cast.framework.CastReceiverContext.getInstance(),this._playerManager=this._context.getPlayerManager(),this._player=t,this._bindMethods(),this._attachListeners()}return i(e,[{key:"skipAd",value:function(){this._logger.debug("Skip ad");var e=new cast.framework.messages.RequestData(cast.framework.messages.MessageType.SKIP_AD);this._playerManager.sendLocalMediaRequest(e)}},{key:"adBreak",value:function(){return!!this._adBreak}},{key:"_bindMethods",value:function(){this._onPlayerLoadComplete=this._onPlayerLoadComplete.bind(this),this._onBreakStarted=this._onBreakStarted.bind(this),this._onBreakEnded=this._onBreakEnded.bind(this),this._onBreakClipLoading=this._onBreakClipLoading.bind(this),this._onBreakClipStarted=this._onBreakClipStarted.bind(this),this._onBreakClipEnded=this._onBreakClipEnded.bind(this),this._onAdPaused=this._onAdPaused.bind(this),this._onAdResumed=this._onAdResumed.bind(this),this._onAdProgress=this._onAdProgress.bind(this),this._onMuteChange=this._onMuteChange.bind(this),this._onVolumeChange=this._onVolumeChange.bind(this)}},{key:"_attachListeners",value:function(){var e,t,a,r=this;this._adLifecycleEventHandlers=(e={},n(e,cast.framework.events.EventType.PLAYER_LOAD_COMPLETE,this._onPlayerLoadComplete),n(e,cast.framework.events.EventType.BREAK_STARTED,this._onBreakStarted),n(e,cast.framework.events.EventType.BREAK_ENDED,this._onBreakEnded),n(e,cast.framework.events.EventType.BREAK_CLIP_LOADING,this._onBreakClipLoading),n(e,cast.framework.events.EventType.BREAK_CLIP_STARTED,this._onBreakClipStarted),n(e,cast.framework.events.EventType.BREAK_CLIP_ENDED,this._onBreakClipEnded),e),this._adTrackingEventHandlers=(t={},n(t,cast.framework.events.EventType.PAUSE,this._onAdPaused),n(t,cast.framework.events.EventType.PLAY,this._onAdResumed),t),this._playerEventHandlers=(a={},n(a,u.MUTE_CHANGE,this._onMuteChange),n(a,u.VOLUME_CHANGE,this._onVolumeChange),a),Object.keys(this._adLifecycleEventHandlers).forEach(function(e){return r._playerManager.addEventListener(e,r._adLifecycleEventHandlers[e])})}},{key:"_onPlayerLoadComplete",value:function(){var e=[],t=this._playerManager.getBreakManager();if(t){var a=t.getBreaks();a&&a.length>0&&(a.forEach(function(t){return e.push(t.position)}),this._sendEventAndCustomMessage(this._player.Event.AD_MANIFEST_LOADED,{adBreaksPosition:e}))}}},{key:"_onBreakStarted",value:function(e){this._toggleAdBreakListeners(!0);var t=this._getAdBreakOptions(e),a=new c(t);this._sendEventAndCustomMessage(this._player.Event.AD_BREAK_START,{adBreak:a}),this._adBreak=a}},{key:"_onBreakEnded",value:function(e){this._toggleAdBreakListeners(!1),this._sendEventAndCustomMessage(this._player.Event.AD_BREAK_END),this._adBreak=null;var t=this._playerManager.getBreakManager().getBreaks();t.findIndex(function(t){return t.id===e.breakId})+1===t.length&&this._sendEventAndCustomMessage(this._player.Event.ALL_ADS_COMPLETED)}},{key:"_onBreakClipLoading",value:function(e){var t=this._getAdOptions(e),a=new l(e.breakClipId,t);this._sendEventAndCustomMessage(this._player.Event.AD_LOADED,{ad:a}),this._ad=a}},{key:"_onBreakClipStarted",value:function(e){var t=this._getAdOptions(e),a=new l(e.breakClipId,t);this._sendEventAndCustomMessage(this._player.Event.AD_STARTED,{ad:a}),this._adIsPlaying=!0}},{key:"_onBreakClipEnded",value:function(){this._sendEventAndCustomMessage(this._player.Event.AD_COMPLETED),this._adIsPlaying=!1,this._adCanSkipTriggered=!1,this._ad=null}},{key:"_onAdPaused",value:function(){this._sendEventAndCustomMessage(this._player.Event.AD_PAUSED),this._adIsPlaying=!1}},{key:"_onAdResumed",value:function(){this._sendEventAndCustomMessage(this._player.Event.AD_RESUMED),this._adIsPlaying=!0}},{key:"_onAdProgress",value:function(){if(this._ad){var e=this._playerManager.getBreakClipDurationSec(),t=this._playerManager.getBreakClipCurrentTimeSec(),a=t/e;!this._timePercentEvent.AD_REACHED_25_PERCENT&&a>=.25&&(this._timePercentEvent.AD_REACHED_25_PERCENT=!0,this._sendEventAndCustomMessage(this._player.Event.AD_FIRST_QUARTILE)),!this._timePercentEvent.AD_REACHED_50_PERCENT&&a>=.5&&(this._timePercentEvent.AD_REACHED_50_PERCENT=!0,this._sendEventAndCustomMessage(this._player.Event.AD_MIDPOINT)),!this._timePercentEvent.AD_REACHED_75_PERCENT&&a>=.75&&(this._timePercentEvent.AD_REACHED_75_PERCENT=!0,this._sendEventAndCustomMessage(this._player.Event.AD_THIRD_QUARTILE)),!this._adCanSkipTriggered&&this._ad.skippable&&t>=this._ad.skipOffset&&(this._sendEventAndCustomMessage(this._player.Event.AD_CAN_SKIP),this._adCanSkipTriggered=!0),this._sendEventAndCustomMessage(this._player.Event.AD_PROGRESS,{adProgress:{currentTime:t,duration:e}})}}},{key:"_onMuteChange",value:function(){this._player.muted&&this._sendEventAndCustomMessage(this._player.Event.AD_MUTED)}},{key:"_onVolumeChange",value:function(){this._sendEventAndCustomMessage(this._player.Event.AD_VOLUME_CHANGED)}},{key:"_toggleAdBreakListeners",value:function(e){var t=this;e?(Object.keys(this._adTrackingEventHandlers).forEach(function(e){return t._playerManager.addEventListener(e,t._adTrackingEventHandlers[e])}),Object.keys(this._playerEventHandlers).forEach(function(e){return t._player.addEventListener(e,t._playerEventHandlers[e])}),this._adProgressIntervalId=setInterval(this._onAdProgress,300)):(Object.keys(this._adTrackingEventHandlers).forEach(function(e){return t._playerManager.removeEventListener(e,t._adTrackingEventHandlers[e])}),Object.keys(this._playerEventHandlers).forEach(function(e){return t._player.removeEventListener(e,t._playerEventHandlers[e])}),clearInterval(this._adProgressIntervalId),this._adProgressIntervalId=null)}},{key:"_getAdBreakOptions",value:function(e){var t={},a=this._playerManager.getBreakManager().getBreakById(e.breakId);return a&&(t.position=a.position,t.type=this._getAdBreakTypeByPosition(a.position),t.numAds=a.breakClipIds.length),t}},{key:"_getAdBreakTypeByPosition",value:function(e){switch(e){case 0:return d.PRE;case-1:return d.POST;default:return d.MID}}},{key:"_getAdOptions",value:function(e){var t={},a=this._playerManager.getBreakManager().getBreakById(e.breakId);if(a){var n=this._playerManager.getBreakManager().getBreakClipById(e.breakClipId);t.url=n.contentId,t.contentType=n.contentType,t.title=n.title,t.position=a.breakClipIds.indexOf(n.id)+1,t.duration=n.duration,t.clickThroughUrl=n.clickThroughUrl,t.posterUrl=n.posterUrl,t.skipOffset=n.whenSkippable,t.linear=!0}return t}},{key:"_sendEventAndCustomMessage",value:function(e,t){this._logger.debug(e.toUpperCase(),t),this._player.dispatchEvent(new h(e,t)),this._context.sendCustomMessage(o.CUSTOM_CHANNEL,void 0,new y(e,t))}}]),e}();t.ReceiverAdsManager=g}])});
//# sourceMappingURL=playkit-cast-receiver.js.map